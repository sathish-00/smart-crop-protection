<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nearby Farmer Shops Finder</title>
  
  <link rel="stylesheet" href="{{ url_for('static', filename='css/shop_finder.css') }}">

</head>

<body>

  <header>
    <div class="header-left">
      <a href="{{ url_for('main.index') }}" class="back-btn">‚Üê Back</a>
    </div>
    
    <div class="header-center" id="pageTitle">
      Farmer Shop Finder
    </div>
    
    <div class="header-right">
      <button class="lang-btn" id="langToggle" onclick="toggleLanguage()">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</button>
    </div>
  </header>

<div class="container">

  <div class="card">
    <p class="note" id="noteText">
      Sample data from OpenStreetMap. Rural coverage may vary.
    </p>

    <label id="lblAddress">Enter Area / Town</label>
    <input id="address" class="input-box" placeholder="Example: Guntur mandi">

    <label id="lblRadius">Select Distance</label>
    <select id="radius" class="input-box">
      <option value="10">10 km</option>
      <option value="20" selected>20 km</option>
      <option value="30">30 km</option>
      <option value="50">50 km</option>
      <option value="100">100 km</option>
    </select>

    <button id="btnFind" class="primary-btn" onclick="search()">
      Find Shops
    
    <button onclick="openGoogleMapsSearch()" class="gmaps-btn" id="btnGoogle">
       Search on Google Maps App
    </button>
  </div>

  

<script>
/* ---------- Language Handling ---------- */
let currentLang = localStorage.getItem("shop_lang") || "en";

const translations = {
    en: {
        title: "Farmer Shop Finder",
        langBtn: "‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å",
        note: "Sample data from OpenStreetMap. Rural coverage may vary.",
        lblAddress: "Enter Area / Town",
        placeholder: "Example: Guntur mandi",
        lblRadius: "Select Distance",
        
        btnGoogle: "Search on Google Maps App", // English Text
        lblResults: "Results",
        defaultRes: "Enter a location to search.",
        finding: "Finding location...",
        notFound: "Location not found.",
        noShops: "No farmer-related shops found in OpenStreetMap for this area.<br><br>üëâ This is common in rural regions.<br>üëâ Try a nearby town or mandi for demo.",
        openMap: "Open in Google Maps",
        errorLoc: "Error fetching location.",
        errorShop: "Error fetching shops data."
    },
    te: {
        title: "‡∞∞‡±à‡∞§‡±Å ‡∞¶‡±Å‡∞ï‡∞æ‡∞£‡∞æ‡∞≤ ‡∞Ö‡∞®‡±ç‡∞µ‡±á‡∞∑‡∞£",
        langBtn: "English",
        note: "‡∞ì‡∞™‡±Ü‡∞®‡±ç ‡∞∏‡±ç‡∞ü‡±ç‡∞∞‡±Ä‡∞ü‡±ç ‡∞Æ‡±ç‡∞Ø‡∞æ‡∞™‡±ç ‡∞®‡±Å‡∞Ç‡∞°‡∞ø ‡∞®‡∞Æ‡±Ç‡∞®‡∞æ ‡∞°‡±á‡∞ü‡∞æ. ‡∞ó‡±ç‡∞∞‡∞æ‡∞Æ‡±Ä‡∞£ ‡∞™‡±ç‡∞∞‡∞æ‡∞Ç‡∞§‡∞æ‡∞≤‡±ç‡∞≤‡±ã ‡∞∏‡∞Æ‡∞æ‡∞ö‡∞æ‡∞∞‡∞Ç ‡∞§‡∞ï‡±ç‡∞ï‡±Å‡∞µ‡∞ó‡∞æ ‡∞â‡∞Ç‡∞°‡∞µ‡∞ö‡±ç‡∞ö‡±Å.",
        lblAddress: "‡∞™‡±ç‡∞∞‡∞æ‡∞Ç‡∞§‡∞Ç / ‡∞ä‡∞∞‡±Å ‡∞®‡∞Æ‡±ã‡∞¶‡±Å ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø",
        placeholder: "‡∞â‡∞¶‡∞æ‡∞π‡∞∞‡∞£: ‡∞ó‡±Å‡∞Ç‡∞ü‡±Ç‡∞∞‡±Å ‡∞Æ‡∞æ‡∞∞‡±ç‡∞ï‡±Ü‡∞ü‡±ç",
        lblRadius: "‡∞¶‡±Ç‡∞∞‡∞æ‡∞®‡±ç‡∞®‡∞ø ‡∞é‡∞Ç‡∞ö‡±Å‡∞ï‡±ã‡∞Ç‡∞°‡∞ø",
        
        btnGoogle: "‡∞ó‡±Ç‡∞ó‡±Å‡∞≤‡±ç ‡∞Æ‡±ç‡∞Ø‡∞æ‡∞™‡±ç‡∞∏‡±ç‚Äå‡∞≤‡±ã ‡∞µ‡±Ü‡∞§‡∞ï‡∞Ç‡∞°‡∞ø", // Telugu Text
        lblResults: "‡∞´‡∞≤‡∞ø‡∞§‡∞æ‡∞≤‡±Å",
        defaultRes: "‡∞µ‡±Ü‡∞§‡∞ï‡∞°‡∞æ‡∞®‡∞ø‡∞ï‡∞ø ‡∞í‡∞ï ‡∞™‡±ç‡∞∞‡∞æ‡∞Ç‡∞§‡∞æ‡∞®‡±ç‡∞®‡∞ø ‡∞®‡∞Æ‡±ã‡∞¶‡±Å ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø.",
        finding: "‡∞™‡±ç‡∞∞‡∞æ‡∞Ç‡∞§‡∞æ‡∞®‡±ç‡∞®‡∞ø ‡∞µ‡±Ü‡∞§‡±Å‡∞ï‡±Å‡∞§‡±ã‡∞Ç‡∞¶‡∞ø...",
        notFound: "‡∞™‡±ç‡∞∞‡∞æ‡∞Ç‡∞§‡∞Ç ‡∞¶‡±ä‡∞∞‡∞ï‡∞≤‡±á‡∞¶‡±Å.",
        noShops: "‡∞à ‡∞™‡±ç‡∞∞‡∞æ‡∞Ç‡∞§‡∞Ç‡∞≤‡±ã ‡∞∞‡±à‡∞§‡±Å ‡∞¶‡±Å‡∞ï‡∞æ‡∞£‡∞æ‡∞≤‡±Å ‡∞ï‡∞®‡±Å‡∞ó‡±ä‡∞®‡∞¨‡∞°‡∞≤‡±á‡∞¶‡±Å.<br><br>üëâ ‡∞ó‡±ç‡∞∞‡∞æ‡∞Æ‡±Ä‡∞£ ‡∞™‡±ç‡∞∞‡∞æ‡∞Ç‡∞§‡∞æ‡∞≤‡±ç‡∞≤‡±ã ‡∞á‡∞¶‡∞ø ‡∞∏‡∞æ‡∞ß‡∞æ‡∞∞‡∞£‡∞Ç.<br>üëâ ‡∞¶‡∞ó‡±ç‡∞ó‡∞∞‡±ç‡∞≤‡±ã‡∞®‡∞ø ‡∞™‡∞ü‡±ç‡∞ü‡∞£‡∞Ç ‡∞≤‡±á‡∞¶‡∞æ ‡∞Æ‡∞Ç‡∞°‡±Ä‡∞®‡∞ø ‡∞™‡±ç‡∞∞‡∞Ø‡∞§‡±ç‡∞®‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø.",
        openMap: "‡∞ó‡±Ç‡∞ó‡±Å‡∞≤‡±ç ‡∞Æ‡±ç‡∞Ø‡∞æ‡∞™‡±ç‡∞∏‡±ç‚Äå‡∞≤‡±ã ‡∞§‡±Ü‡∞∞‡∞µ‡∞Ç‡∞°‡∞ø",
        errorLoc: "‡∞™‡±ç‡∞∞‡∞æ‡∞Ç‡∞§‡∞æ‡∞®‡±ç‡∞®‡∞ø ‡∞™‡±ä‡∞Ç‡∞¶‡∞°‡∞Ç‡∞≤‡±ã ‡∞≤‡±ã‡∞™‡∞Ç.",
        errorShop: "‡∞¶‡±Å‡∞ï‡∞æ‡∞£‡∞æ‡∞≤ ‡∞°‡±á‡∞ü‡∞æ‡∞®‡±Å ‡∞™‡±ä‡∞Ç‡∞¶‡∞°‡∞Ç‡∞≤‡±ã ‡∞≤‡±ã‡∞™‡∞Ç."
    }
};

function applyLanguage() {
    const t = translations[currentLang];
    
    document.getElementById("pageTitle").textContent = t.title;
    document.getElementById("langToggle").textContent = t.langBtn;
    document.getElementById("noteText").textContent = t.note;
    document.getElementById("lblAddress").textContent = t.lblAddress;
    document.getElementById("address").placeholder = t.placeholder;
    document.getElementById("lblRadius").textContent = t.lblRadius;
    document.getElementById("btnFind").textContent = t.btnFind;
    
    // ‚úÖ THIS IS THE FIX: Explicitly updating the Google Button Text
    document.getElementById("btnGoogle").textContent = t.btnGoogle;
    
    document.getElementById("lblResults").textContent = t.lblResults;
    
    const resDiv = document.getElementById("results");
    if (resDiv.innerHTML.includes("Enter a location") || resDiv.innerHTML.includes("‡∞µ‡±Ü‡∞§‡∞ï‡∞°‡∞æ‡∞®‡∞ø‡∞ï‡∞ø")) {
        resDiv.textContent = t.defaultRes;
    }
}

function toggleLanguage() {
    currentLang = currentLang === "en" ? "te" : "en";
    localStorage.setItem("shop_lang", currentLang);
    applyLanguage();
}

// Initial Call to set language on load
applyLanguage();


/* ---------- Distance Calculation ---------- */
function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371; 
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(lat1*Math.PI/180) *
    Math.cos(lat2*Math.PI/180) *
    Math.sin(dLon/2)**2;
  return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
}

/* ---------- Google Maps Search (FIXED URL) ---------- */
function openGoogleMapsSearch() {
    const address = document.getElementById("address").value.trim();
    if (!address) {
        alert(currentLang === 'en' ? "Please enter a location first." : "‡∞¶‡∞Ø‡∞ö‡±á‡∞∏‡∞ø ‡∞Æ‡±Å‡∞Ç‡∞¶‡±Å‡∞ó‡∞æ ‡∞≤‡±ä‡∞ï‡±á‡∞∑‡∞®‡±ç‚Äå‡∞®‡±Å ‡∞®‡∞Æ‡±ã‡∞¶‡±Å ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø.");
        return;
    }
    const query = encodeURIComponent("Fertilizer shops near " + address);
    
    // ‚úÖ FIX: Correct URL format to open Google Maps
    window.open(`https://www.google.com/maps/search/?api=1&query=${query}`, '_blank');
}

/* ---------- Main Search ---------- */
async function search() {
  const address = document.getElementById("address").value.trim();
  const radiusKm = parseInt(document.getElementById("radius").value);
  const resultsDiv = document.getElementById("results");
  const t = translations[currentLang];

  if (!address) {
    alert(currentLang === 'en' ? "Enter location" : "‡∞™‡±ç‡∞∞‡∞æ‡∞Ç‡∞§‡∞æ‡∞®‡±ç‡∞®‡∞ø ‡∞®‡∞Æ‡±ã‡∞¶‡±Å ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø");
    return;
  }

  resultsDiv.innerHTML = t.finding;

  try {
    const geoRes = await fetch(
      `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`
    );
    const geo = await geoRes.json();

    if (!geo.length) {
      resultsDiv.innerHTML = t.notFound;
      return;
    }

    fetchOSMShops(parseFloat(geo[0].lat), parseFloat(geo[0].lon), radiusKm);
  } catch (error) {
    resultsDiv.innerHTML = t.errorLoc;
    console.error(error);
  }
}

/* ---------- OSM Fetch ---------- */
async function fetchOSMShops(lat, lon, radiusKm) {
  const resultsDiv = document.getElementById("results");
  const t = translations[currentLang];
  
  resultsDiv.innerHTML = currentLang === 'en' ? "Searching OpenStreetMap..." : "‡∞ì‡∞™‡±Ü‡∞®‡±ç ‡∞∏‡±ç‡∞ü‡±ç‡∞∞‡±Ä‡∞ü‡±ç ‡∞Æ‡±ç‡∞Ø‡∞æ‡∞™‡±ç‚Äå‡∞≤‡±ã ‡∞µ‡±Ü‡∞§‡±Å‡∞ï‡±Å‡∞§‡±ã‡∞Ç‡∞¶‡∞ø...";

  const radiusMeters = radiusKm * 1000;

  const query = `
  [out:json][timeout:40];
  (
    node["shop"](around:${radiusMeters},${lat},${lon});
    way["shop"](around:${radiusMeters},${lat},${lon});
    node["amenity"="marketplace"](around:${radiusMeters},${lat},${lon});
    way["amenity"="marketplace"](around:${radiusMeters},${lat},${lon});
  );
  out center tags;
  `;

  try {
    const res = await fetch("https://overpass-api.de/api/interpreter", {
      method: "POST",
      body: query
    });

    const data = await res.json();

    const shops = data.elements
      .map(el => {
        const lat2 = el.lat || el.center?.lat;
        const lon2 = el.lon || el.center?.lon;
        if (!lat2 || !lon2) return null;

        const d = haversine(lat, lon, lat2, lon2);
        if (d > radiusKm) return null;

        return {
          name: el.tags.name || (currentLang === 'en' ? "Unnamed Shop" : "‡∞™‡±á‡∞∞‡±Å ‡∞≤‡±á‡∞®‡∞ø ‡∞¶‡±Å‡∞ï‡∞æ‡∞£‡∞Ç"),
          lat: lat2,
          lon: lon2,
          distance: d.toFixed(2)
        };
      })
      .filter(Boolean)
      .sort((a,b) => a.distance - b.distance);

    if (!shops.length) {
      resultsDiv.innerHTML = t.noShops;
      return;
    }

    let html = "";
    shops.slice(0,25).forEach(s => {
      // ‚úÖ FIX: Correct Google Maps Pin URL
      const mapLink = `https://www.google.com/maps/search/?api=1&query=${s.lat},${s.lon}`;

      html += `
        <div class="shop-card">
          <div class="shop-card-header">
             ${s.name}
          </div>
          
          <div class="shop-card-body">
             <span class="distance-tag">üìç ${s.distance} km</span>
             <br>
             <a class="map-btn" target="_blank" href="${mapLink}">
               ${t.openMap}
             </a>
          </div>
        </div>
      `;
    });

    resultsDiv.innerHTML = html;
    
  } catch (error) {
    resultsDiv.innerHTML = t.errorShop;
    console.error(error);
  }
}
</script>

</body>
</html>